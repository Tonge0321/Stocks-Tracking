<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Market Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <style>
        /* --- 100% 設計還原區 --- */
        body {
            background-color: #131722; /* TradingView 深色背景 */
            color: #d1d4dc;
            font-family: -apple-system, BlinkMacSystemFont, "Trebuchet MS", Roboto, sans-serif;
            margin: 0;
            padding: 20px;
        }

        /* 標題列 */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 15px;
            margin-bottom: 20px;
            border-bottom: 1px solid #2a2e39;
        }
        h1 { margin: 0; font-size: 24px; color: #fff; letter-spacing: 0.5px; }
        
        .controls { display: flex; gap: 10px; }
        button {
            background: #2a2e39;
            color: #d1d4dc;
            border: 1px solid transparent;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            transition: 0.2s;
        }
        button:hover { background: #363a45; color: #fff; }
        .btn-add { background: #2962ff; color: #fff; } /* 藍色新增按鈕 */
        .btn-add:hover { background: #1e53e5; }

        /* 卡片網格 */
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 16px;
        }

        /* 股票卡片 (TradingView 風格) */
        .card {
            background-color: #1e222d;
            border-radius: 6px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
            padding: 16px;
            position: relative;
            cursor: grab; /* 手型游標 */
            border: 1px solid transparent;
            transition: border-color 0.2s;
        }
        .card:hover { border-color: #404554; }
        .card:active { cursor: grabbing; }

        /* 卡片內部排版 */
        .card-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 8px;
        }
        .symbol { font-size: 20px; font-weight: bold; color: #fff; }
        .badge {
            font-size: 14px; font-weight: 600; padding: 2px 6px; border-radius: 4px;
        }
        /* 漲跌顏色 (精準還原) */
        .up { color: #089981; background: rgba(8, 153, 129, 0.12); }
        .down { color: #f23645; background: rgba(242, 54, 69, 0.12); }
        .neutral { color: #787b86; background: rgba(120, 123, 134, 0.12); }

        .main-price { font-size: 32px; font-weight: bold; color: #fff; margin-bottom: 12px; }

        /* 數據細節欄 */
        .details {
            display: flex; justify-content: space-between;
            border-top: 1px solid #2a2e39;
            padding-top: 10px; margin-top: 10px;
            font-size: 12px; color: #787b86;
        }
        .detail-item span { display: block; }
        .val { color: #d1d4dc; font-family: monospace; margin-top: 2px; }

        /* 圖表區 */
        .chart-container {
            height: 160px; margin-top: 15px; border-radius: 4px; overflow: hidden;
        }

        /* 刪除按鈕 (Hover 時才顯示) */
        .del-btn {
            position: absolute; top: 10px; right: 10px;
            width: 20px; height: 20px;
            text-align: center; line-height: 20px;
            color: #787b86; cursor: pointer;
            opacity: 0; transition: 0.2s; font-weight: bold;
        }
        .card:hover .del-btn { opacity: 1; }
        .del-btn:hover { color: #f23645; }

        /* 載入遮罩 */
        #loading {
            position: fixed; top:0; left:0; width:100%; height:100%;
            background: rgba(19, 23, 34, 0.9);
            display: flex; justify-content: center; align-items: center;
            color: #2962ff; font-size: 20px; font-weight: bold;
            z-index: 999; display: none;
        }
    </style>
</head>
<body>

    <div id="loading">Processing...</div>

    <div class="header">
        <h1>Market Watch</h1>
        <div class="controls">
            <button class="btn-add" onclick="addStock()">+ Add Symbol</button>
            <button onclick="fetchData()">↻ Refresh</button>
        </div>
    </div>

    <div id="dashboard" class="grid">
        </div>

    <script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>
    <script>
        const API_URL = "https://script.google.com/macros/s/AKfycbwbZ-6VDAPGy6j3GOV64WAdgR5JSPZaYpXqoDr7Y5iLCoCOUYF10RNtywY52gntnsWp/exec";

        async function fetchData() {
            showLoading(true);
            try {
                // 加時間戳記防止快取
                const res = await fetch(`${API_URL}?t=${Date.now()}`);
                const data = await res.json();
                renderCards(data);
            } catch (e) {
                alert("連線錯誤: " + e.message);
            } finally {
                showLoading(false);
            }
        }

        function renderCards(data) {
            const container = document.getElementById('dashboard');
            container.innerHTML = "";

            if (!data || data.length === 0) {
                container.innerHTML = "<div style='color:#787b86'>No Data. Add a stock to start.</div>";
                return;
            }

            data.forEach((item, index) => {
                // 過濾無效資料
                if(item.symbol === 'SYSTEM_OK') return;

                const card = document.createElement('div');
                card.className = 'card';
                card.dataset.symbol = item.symbol; // 用於排序
                
                // 顏色判斷
                let pct = item.changePercent || "0%";
                let type = 'neutral';
                if(pct.includes('-')) type = 'down';
                else if(pct !== "0%" && pct !== "0.00%") type = 'up';

                const chartId = `chart_${index}_${item.symbol}`;

                card.innerHTML = `
                    <div class="del-btn" onclick="deleteStock('${item.symbol}')" title="Remove">✕</div>
                    <div class="card-header">
                        <span class="symbol">${item.symbol}</span>
                        <span class="badge ${type}">${pct}</span>
                    </div>
                    <div class="main-price">${item.price}</div>
                    
                    <div class="details">
                        <div class="detail-item">
                            <span>High</span><span class="val">${item.high || '-'}</span>
                        </div>
                        <div class="detail-item">
                            <span>Low</span><span class="val">${item.low || '-'}</span>
                        </div>
                        <div class="detail-item">
                            <span>Change</span><span class="val">${item.futuresPrice || '-'}</span>
                        </div>
                    </div>

                    <div id="${chartId}" class="chart-container"></div>
                `;
                
                container.appendChild(card);

                // TradingView Widget
                new TradingView.widget({
                    "autosize": true,
                    "symbol": item.symbol,
                    "interval": "D",
                    "timezone": "Asia/Taipei",
                    "theme": "dark",
                    "style": "1", // 1=K線
                    "locale": "en",
                    "toolbar_bg": "#f1f3f6",
                    "enable_publishing": false,
                    "hide_top_toolbar": true,
                    "hide_legend": true,
                    "container_id": chartId,
                    "isTransparent": true
                });
            });

            // 啟動拖曳排序
            new Sortable(container, {
                animation: 150,
                ghostClass: 'sort-ghost',
                onEnd: function() {
                    saveOrder();
                }
            });
        }

        async function addStock() {
            const sym = prompt("輸入股票代碼 (例如 TSLA 或 2330.TW):");
            if(!sym) return;
            
            showLoading(true);
            // 傳送指令給 Apps Script
            await fetch(API_URL, {
                method: 'POST',
                mode: 'no-cors',
                body: JSON.stringify({action: 'add', symbol: sym.toUpperCase()})
            });
            // 稍等後重新整理
            setTimeout(fetchData, 2000);
        }

        async function deleteStock(sym) {
            if(!confirm("確定刪除 " + sym + "?")) return;
            showLoading(true);
            await fetch(API_URL, {
                method: 'POST',
                mode: 'no-cors',
                body: JSON.stringify({action: 'delete', symbol: sym})
            });
            setTimeout(fetchData, 2000);
        }

        async function saveOrder() {
            // 取得目前順序
            const cards = document.querySelectorAll('.card');
            const newOrder = Array.from(cards).map(c => c.dataset.symbol);
            
            // 背景儲存，不阻擋 UI
            fetch(API_URL, {
                method: 'POST',
                mode: 'no-cors',
                body: JSON.stringify({action: 'reorder', orderList: newOrder})
            });
        }

        function showLoading(show) {
            document.getElementById('loading').style.display = show ? 'flex' : 'none';
        }

        window.onload = fetchData;
    </script>
</body>
</html>
