<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Market Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <style>
        /* --- 100% 還原設計風格 --- */
        body {
            background-color: #0d1117; /* GitHub Dark Dimmed 深色背景 */
            color: #c9d1d9;            /* 柔和白字 */
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 20px;
        }

        /* 頂部標題列 */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #30363d;
        }
        h1 { margin: 0; font-size: 24px; color: #f0f6fc; }
        
        /* 控制按鈕群 */
        .controls { display: flex; gap: 8px; }
        .btn {
            border: 1px solid rgba(240, 246, 252, 0.1);
            border-radius: 6px;
            padding: 5px 12px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            color: #c9d1d9;
            background: #21262d;
            transition: 0.2s;
        }
        .btn:hover { background: #30363d; border-color: #8b949e; }
        .btn-primary { background: #238636; color: white; border: none; }
        .btn-primary:hover { background: #2ea043; }

        /* 格狀佈局 */
        .grid-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 16px;
        }

        /* 股票卡片 */
        .stock-card {
            background-color: #161b22; /* 卡片深灰底 */
            border: 1px solid #30363d;
            border-radius: 6px;
            padding: 16px;
            position: relative;
            cursor: grab; /* 拖曳手勢 */
            transition: transform 0.2s, border-color 0.2s;
        }
        .stock-card:hover { border-color: #58a6ff; }
        .stock-card:active { cursor: grabbing; }

        /* 刪除按鈕 (Hover 顯示) */
        .delete-btn {
            position: absolute; top: 10px; right: 10px;
            color: #8b949e; cursor: pointer; font-size: 16px;
            opacity: 0; transition: 0.2s;
        }
        .stock-card:hover .delete-btn { opacity: 1; }
        .delete-btn:hover { color: #f85149; }

        /* 卡片內容排版 */
        .card-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 8px;
        }
        .symbol { font-size: 20px; font-weight: 600; color: #58a6ff; }
        
        /* 漲跌標籤 (圓角矩形) */
        .badge { padding: 2px 8px; border-radius: 12px; font-size: 13px; font-weight: 600; }
        .up { color: #3fb950; background: rgba(63, 185, 80, 0.15); border: 1px solid rgba(63, 185, 80, 0.4); }
        .down { color: #f85149; background: rgba(248, 81, 73, 0.15); border: 1px solid rgba(248, 81, 73, 0.4); }
        .neutral { color: #8b949e; background: rgba(110, 118, 129, 0.15); }

        .price { font-size: 32px; font-weight: 700; color: #f0f6fc; margin-bottom: 12px; }

        /* 詳細資訊 (格狀排列) */
        .details {
            display: grid; grid-template-columns: 1fr 1fr; gap: 8px;
            font-size: 12px; color: #8b949e;
            border-top: 1px solid #30363d; padding-top: 10px;
        }
        .detail-item span { display: block; margin-bottom: 2px; }
        .val { color: #c9d1d9; font-family: monospace; font-size: 13px; }

        /* 圖表區 */
        .chart-box { height: 150px; margin-top: 15px; border-radius: 4px; overflow: hidden; }

        /* 載入遮罩 */
        #loading {
            position: fixed; top:0; left:0; width:100%; height:100%;
            background: rgba(13, 17, 23, 0.9);
            display: flex; justify-content: center; align-items: center;
            color: #58a6ff; font-size: 18px; font-weight: bold;
            z-index: 999; display: none;
        }
    </style>
</head>
<body>

    <div id="loading">Processing...</div>

    <div class="header">
        <h1>Market Watch</h1>
        <div class="controls">
            <button class="btn btn-primary" onclick="addStock()">+ Add Stock</button>
            <button class="btn" onclick="fetchData()">↻ Refresh</button>
        </div>
    </div>

    <div id="dashboard" class="grid-container">
        </div>

    <script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>

    <script>
        // ★★★ 這裡填入您的 Apps Script 網址 ★★★
        const API_URL = "https://script.google.com/macros/s/AKfycbwbZ-6VDAPGy6j3GOV64WAdgR5JSPZaYpXqoDr7Y5iLCoCOUYF10RNtywY52gntnsWp/exec";

        async function fetchData() {
            showLoading(true);
            try {
                // 加 timestamp 防止快取
                const res = await fetch(`${API_URL}?t=${Date.now()}`);
                const data = await res.json();
                renderCards(data);
            } catch (e) {
                alert("Load failed: " + e.message);
            } finally {
                showLoading(false);
            }
        }

        function renderCards(data) {
            const container = document.getElementById('dashboard');
            container.innerHTML = "";

            if (!data || data.length === 0) {
                container.innerHTML = "<div style='color:#8b949e; padding:20px'>No Data. Click '+ Add Stock' to start.</div>";
                return;
            }

            data.forEach((stock, index) => {
                if (stock.symbol === 'SYSTEM_OK') return;

                const card = document.createElement('div');
                card.className = 'stock-card';
                card.dataset.symbol = stock.symbol; // 用於排序

                // 顏色判斷
                let pct = stock.changePercent || "0%";
                let type = 'neutral';
                if (pct.includes('-')) type = 'down';
                else if (pct !== "0%" && pct !== "0.00%") type = 'up';

                const chartId = `chart_${index}_${stock.symbol}`;

                card.innerHTML = `
                    <div class="delete-btn" onclick="deleteStock('${stock.symbol}')" title="Delete">✕</div>
                    <div class="card-header">
                        <span class="symbol">${stock.symbol}</span>
                        <span class="badge ${type}">${pct}</span>
                    </div>
                    <div class="price">${stock.price}</div>
                    
                    <div class="details">
                        <div class="detail-item"><span>Day
